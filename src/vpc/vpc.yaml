AWSTemplateFormatVersion: '2010-09-09'
Description: kube-aws-secure VPC (Public and Private Subnets, IGW, Route Tables, KMS)

Parameters:
  Role:
    Type: String
  ServiceNamePrefix:
    Type: String
  KubernetesCluster:
    Type: String

  InstanceType:
    Description: EC2 HVM instance type.
    Type: String
    Default: t2.micro
    AllowedValues:
    - t2.micro
    - t2.small
    - t2.medium
    ConstraintDescription: Must be a valid EC2 HVM instance type.
  KeyPair:
    Description: The name of an EC2 Key Pair to allow SSH access to the instance.
    Default: key_name
    Type: String

Mappings:
  ConfigMap:
    Environment:
      VPC:            10.0.0.0/16

      PublicSubnetA:  10.0.101.0/24
      PublicSubnetB:  10.0.102.0/24
      PublicSubnetC:  10.0.103.0/24

      PrivateSubnetA: 10.0.1.0/24
      PrivateSubnetB: 10.0.2.0/24
      PrivateSubnetC: 10.0.3.0/24

      FnGetAZs:       ["aws_regiona", "aws_regionb", "aws_regionc"]

Resources:
  #KMS
  KubeAwsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: "KubeAWS KMS key"
      KeyPolicy:
        Version: "2012-10-17"
        Id: !Sub "key-k8s"
        Statement:
          - Sid: "Enable IAM User Permissions"
            Effect: "Allow"
            Principal:
              AWS: !Sub "arn:aws:sts::${AWS::AccountId}:root"
            Action:
              - "kms:*"
            Resource: "*"
  # VPC
  KubeAwsVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock:          !FindInMap [ConfigMap, Environment, VPC]
      EnableDnsSupport:   true
      EnableDnsHostnames: true
      InstanceTenancy:    default
      Tags:
        - Key:   Name
          Value: !Ref ServiceNamePrefix
        - Key:   Role
          Value: !Ref Role

#DHCP Options
  KubeDhcpOptions:
    Type: "AWS::EC2::DHCPOptions"
    Properties:
      DomainName: ec2.internal
      DomainNameServers:
        - AmazonProvidedDNS
      Tags:
        - Key:   Name
          Value: !Sub "${ServiceNamePrefix}-dhcp-options"
        - Key:   Role
          Value: !Ref Role

  KubeVPCDHCPOptionsAssociation:
    Type: AWS::EC2::VPCDHCPOptionsAssociation
    Properties:
      VpcId:
        Ref: KubeAwsVPC
      DhcpOptionsId:
        Ref: KubeDhcpOptions

  # IGW
  PublicInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key:   Name
          Value: !Sub "${ServiceNamePrefix}-igw"
        - Key:   Role
          Value: !Ref Role

  PublicVPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:             !Ref KubeAwsVPC
      InternetGatewayId: !Ref PublicInternetGateway

  # Nat GW

  NATGatewayEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId:     !Ref PublicSubnetA

  PublicVPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:             !Ref KubeAwsVPC
      InternetGatewayId: !Ref PublicInternetGateway

  ### Public Subnets
  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:               !Ref KubeAwsVPC
      CidrBlock:           !FindInMap [ConfigMap, Environment, PublicSubnetA]
      MapPublicIpOnLaunch: true
      AvailabilityZone:    !Select [0, !FindInMap [ConfigMap, Environment, FnGetAZs]]
      Tags:
        - Key:   Name
          Value: !Sub "${ServiceNamePrefix}-public-subnet-a"
        - Key:   Role
          Value: !Ref Role
        - Key:   KubernetesCluster
          Value: !Ref KubernetesCluster

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:               !Ref KubeAwsVPC
      CidrBlock:           !FindInMap [ConfigMap, Environment, PublicSubnetB]
      MapPublicIpOnLaunch: true
      AvailabilityZone:    !Select [1, !FindInMap [ConfigMap, Environment, FnGetAZs]]
      Tags:
        - Key:   Name
          Value: !Sub "${ServiceNamePrefix}-public-subnet-b"
        - Key:   Role
          Value: !Ref Role
        - Key:   KubernetesCluster
          Value: !Ref KubernetesCluster

  PublicSubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:               !Ref KubeAwsVPC
      CidrBlock:           !FindInMap [ConfigMap, Environment, PublicSubnetC]
      MapPublicIpOnLaunch: true
      AvailabilityZone:    !Select [2, !FindInMap [ConfigMap, Environment, FnGetAZs]]
      Tags:
        - Key:   Name
          Value: !Sub "${ServiceNamePrefix}-public-subnet-c"
        - Key:   Role
          Value: !Ref Role
        - Key:   KubernetesCluster
          Value: !Ref KubernetesCluster

  ### Private Subnets
  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:            !Ref KubeAwsVPC
      CidrBlock:        !FindInMap [ConfigMap, Environment, PrivateSubnetA]
      AvailabilityZone: !Select [0, !FindInMap [ConfigMap, Environment, FnGetAZs]]
      Tags:
        - Key:   Name
          Value: !Sub "${ServiceNamePrefix}-private-subnet-a"
        - Key:   Role
          Value: !Ref Role

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:            !Ref KubeAwsVPC
      CidrBlock:        !FindInMap [ConfigMap, Environment, PrivateSubnetB]
      AvailabilityZone: !Select [1, !FindInMap [ConfigMap, Environment, FnGetAZs]]
      Tags:
        - Key:   Name
          Value: !Sub "${ServiceNamePrefix}-private-subnet-b"
        - Key:   Role
          Value: !Ref Role

  PrivateSubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:            !Ref KubeAwsVPC
      CidrBlock:        !FindInMap [ConfigMap, Environment, PrivateSubnetC]
      AvailabilityZone: !Select [2, !FindInMap [ConfigMap, Environment, FnGetAZs]]
      Tags:
        - Key:   Name
          Value: !Sub "${ServiceNamePrefix}-private-subnet-c"
        - Key:   Role
          Value: !Ref Role

  ### Public Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref KubeAwsVPC

      Tags:
        - Key:   Name
          Value: !Sub "${ServiceNamePrefix}-public-routes"
        - Key:   Role
          Value: !Ref Role

  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId:     !Ref PublicSubnetA

  PublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId:     !Ref PublicSubnetB

  PublicSubnetCRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId:     !Ref PublicSubnetC

  PublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:         !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:            !Ref PublicInternetGateway

  ### Private Route Table
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref KubeAwsVPC

      Tags:
        - Key:   Name
          Value: !Sub "${ServiceNamePrefix}-private-routes"
        - Key:   Role
          Value: !Ref Role

  PrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId:     !Ref PrivateSubnetA

  PrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId:     !Ref PrivateSubnetB

  PrivateSubnetCRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId:     !Ref PrivateSubnetC

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      RouteTableId:         !Ref PrivateRouteTable
      NatGatewayId:         !Ref NATGateway


#VPN

  ControlPortAddress:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  AssociateControlPort:
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !GetAtt ControlPortAddress.AllocationId
      NetworkInterfaceId: !Ref eth0
  SSHSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref KubeAwsVPC
      GroupDescription: Enable SSH access via port 22 from current IP
      SecurityGroupIngress:
      - CidrIp: 0.0.0.0/0
        FromPort: 22
        IpProtocol: tcp
        ToPort: 22
  WebSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref KubeAwsVPC
      GroupDescription: Enable HTTPS access from current IP
      SecurityGroupIngress:
      - CidrIp: 0.0.0.0/0
        FromPort: 443
        IpProtocol: tcp
        ToPort: 443
  VPNSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref KubeAwsVPC
      GroupDescription: Enable VPN access via port 34000 from everywhere
      SecurityGroupIngress:
      - CidrIp: 0.0.0.0/0
        FromPort: 34000
        IpProtocol: tcp
        ToPort: 34000
  eth0:
    Type: AWS::EC2::NetworkInterface
    Properties:
      SubnetId: !Ref PublicSubnetA
      Description: Vpn interface
      GroupSet:
      - !Ref SSHSecurityGroup
      - !Ref WebSecurityGroup
      - !Ref VPNSecurityGroup
      SourceDestCheck: true
      Tags:
        -
          Key: Network
          Value: Control
  Ec2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami_id
      KeyName: !Ref KeyPair
      InstanceType: !Ref InstanceType
      NetworkInterfaces:
        -
          NetworkInterfaceId: !Ref eth0
          DeviceIndex: 0
      Tags:
        -
          Key: Role
          Value: Vpn
      UserData: H4sICK+VBFoAA3ZwbgC9VUmP0zAUvvdXPDJzgIObIiGQgnxgxCBxAFUzLIdSIcd5aUwTO9hO2krz47Gzlk7KDBzIIctbvvf5bbnguaoSwpVMxWbGlUZlohlAVSbMon8D0BgrZYmx2ok2hwgClaaBN5LCmtaGgGQFRlBqYSuZzw3qWnBsdAAoWZw7rdVVL+KqKJhMIjCWaTsIpUVpI7jrBACrzy7Ievh8i4ZrUVqhJF22seDL8uOgv8GfldBoaKL4FvUJD4A3qUVNa6ZJLmLSsy1UJe1sjHnbeo1hr/fIbz3RpUZKwsroMBYyLLaJ0EBKCB1i6BDDDrF//jtAoeRGJfF9ADo4t0cEXUn4Ntj1FyG+ILSDmzRI0DKeTaqcWy1y3GAyDY12p/SWZsrYSQNXgYYry3fsYKZM6rNHjgZFJ3ike/eMThUT7j9EWYp7Nbr5jfSp+BY5fbkwR13yXjpFno9d8pW59k2uDrSocitI5Zpv7lw32PVWPyTT7ddiTI7KQ1NxhambXHo6fKP5Bx/hiGjGXB8lWIf7OuFHYnQop/kb1J8OJVLc2xd/ykE3gD4Lk3T6HDjCBbN9Ckit8qrA/7I23jWRTb+qAGMDbfiTLeHyQ3x+5u7leIeMO+aMQVeOv94yTYKVRJMpexStYEI2jK73wtIDjq15tBRUaZul4OtDuuS2pyJKcoSx2o8r3hnyO/eJ31O3G5rFT6BkNovgofBNhBJ1IYxxNTARLF4tFo1U7STqCLT7xUT+Npus6MWTBj5mJgPSZ1qksFpBcPl0J0pMDRDpV+nlc7iDjcYSPJlnAVAKQQDr9WuboRzOWmxTM/cWzqHvt9yMRUSeKQjaM3hMYYDlGlly6HrXjXrQWadi9gt2tciBSQcAAA==
  DataVolume:
    Type: AWS::EC2::Volume
    Properties:
      Size: 5
      AvailabilityZone: !GetAtt Ec2Instance.AvailabilityZone
  MountPoint:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      InstanceId: !Ref Ec2Instance
      VolumeId: !Ref DataVolume
      Device: /dev/xvdc


Outputs:
  VpcId:
    Value: !Ref KubeAwsVPC

  CidrBlock:
    Value: !GetAtt KubeAwsVPC.CidrBlock

  PublicRouteTableId:
    Value: !Ref PublicRouteTable
  PrivateRouteTableId:
    Value: !Ref PrivateRouteTable

  PublicSubnetAId:
    Value: !Ref PublicSubnetA
  PublicSubnetBId:
    Value: !Ref PublicSubnetB
  PublicSubnetCId:
    Value: !Ref PublicSubnetC

  PrivateSubnetAId:
    Value: !Ref PrivateSubnetA
  PrivateSubnetBId:
    Value: !Ref PrivateSubnetB
  PrivateSubnetCId:
    Value: !Ref PrivateSubnetC

  KMSKeyArn:
    Value: !GetAtt KubeAwsKey.Arn
